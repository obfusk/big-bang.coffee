<!DOCTYPE html>

<html>
<head>
  <title>bigbang.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bigbang.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <!--
##
{{{1 -->

<pre><code>File        : bigbang.coffee
Maintainer  : Felix C. Stegerman &lt;flx<span class="hljs-property">@obfusk</span>.net&gt;
Date        : <span class="hljs-number">2014</span>-<span class="hljs-number">04</span>-<span class="hljs-number">03</span>

Copyright   : Copyright (C) <span class="hljs-number">2014</span>  Felix C. Stegerman
Licence     : LGPLv3+
</code></pre><!-- }}}1
##
-->

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>graphical/evented functional programming for js/coffee</p>
<p>Create graphical and evented programs (like games) in coffeescript
or javascript using plain mathematical functions; inspired by the
2htdp library for racket.</p>
<p><a href="https://github.com/obfusk/bigbang.coffee">https://github.com/obfusk/bigbang.coffee</a></p>
<p>License: LGPLv3+.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="underscore-exports">underscore + exports</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
U = <span class="hljs-keyword">this</span>._ || <span class="hljs-built_in">require</span> <span class="hljs-string">'underscore'</span>
<span class="hljs-function"><span class="hljs-title">B</span> = -&gt;</span> B.bigbang arguments...
<span class="hljs-keyword">if</span> <span class="hljs-built_in">exports</span>? <span class="hljs-keyword">then</span> <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = B <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.bigbang = B</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="requestanimationframe-polyfill">requestAnimationFrame &amp; polyfill</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>requestAnimationFrame polyfill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.polyRequestAnimationFrame = polyRequestAnimationFrame =       <span class="hljs-comment"># {{{1</span>
  <span class="hljs-function"><span class="hljs-params">(delay = <span class="hljs-number">17</span>)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.warn <span class="hljs-string">'polyfilling *RequestAnimationFrame ...'</span>
    last = <span class="hljs-number">0</span>
    <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
      cur   = +<span class="hljs-keyword">new</span> Date
      dt    = Math.max <span class="hljs-number">0</span>, delay - (cur - last)
      last  = cur + dt
      <span class="hljs-built_in">window</span>.setTimeout (<span class="hljs-function">-&gt;</span> cb +<span class="hljs-keyword">new</span> Date), dt</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>NB: we use the prefixed versions of requestAnimationFrame b/c
requestAnimationFrame itself uses relative timestamps; also good to
know: webkitRequestAnimationFrame uses floating point timestamps.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.requestAnimationFrame = requestAnimationFrame =
  <span class="hljs-built_in">window</span>?.webkitRequestAnimationFrame ||
  <span class="hljs-built_in">window</span>?.mozRequestAnimationFrame ||
  polyRequestAnimationFrame()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="bigbang-stop_with">bigbang &amp; stop_with</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>big bang: start a new universe whose behaviour is specified by the
options and handler functions designated</p>
<pre><code>bigbang
  <span class="hljs-attribute">canvas</span>:     element,
  <span class="hljs-attribute">fps</span>:        int,
  <span class="hljs-attribute">world</span>:      object,
  <span class="hljs-attribute">tickless</span>:   boolean,
  <span class="hljs-attribute">on_tick</span>:    <span class="hljs-function"><span class="hljs-params">((world, time) -&gt; new_world)</span>,
  <span class="hljs-title">on_key</span>:     <span class="hljs-params">((world, key) -&gt; new_world)</span>,
  <span class="hljs-title">on_click</span>:   <span class="hljs-params">((world, x, y) -&gt; new_world)</span>,
  <span class="hljs-title">on</span>:         { <span class="hljs-title">foo</span>: <span class="hljs-params">((world, ...) -&gt; new_world)</span>, ... },
  <span class="hljs-title">to_draw</span>:    <span class="hljs-params">((world) -&gt; scene)</span>,
  <span class="hljs-title">stop_when</span>:  <span class="hljs-params">((world) -&gt; boolean)</span>,
  <span class="hljs-title">last_draw</span>:  <span class="hljs-params">((world) -&gt; scene)</span>,
  <span class="hljs-title">setup</span>:      <span class="hljs-params">((canvas, handlers) -&gt; setup_value)</span>,
  <span class="hljs-title">teardown</span>:   <span class="hljs-params">((canvas, handlers, setup_value) -&gt;
                  teardown_value)</span>,
  <span class="hljs-title">on_stop</span>:    <span class="hljs-params">((world, teardown_value) -&gt; ...)</span></span>
</code></pre><p>Options:</p>
<ul>
<li><code>canvas</code> is the HTML5 canvas to draw on</li>
<li><code>fps</code> is the requested frame rate; defaults to 60</li>
<li><code>world</code> is the object representing the initial world</li>
<li>(optional) <code>tickless</code> specifies whether events are processed
directly, or whether there is a ticking clock and changes are
queued and processed every clock tick (which calls <code>on_tick</code> at
the requested frame rate); defaults to false</li>
<li>(optional) <code>on_tick</code> is called every clock tick to update the
world</li>
<li>(optional) <code>on_key</code> is called every time a key is pressed to
update the world</li>
<li>(optional) <code>on_click</code> is called every time the mouse is clicked
inside the canvas to update the world</li>
<li>(optional) <code>on</code> contains handlers for user-defined events;
<code>setup</code> and <code>teardown</code> are used to connect handlers to elements
and events; when the user-defined event is triggered, the
appropriate function is called</li>
<li><code>to_draw</code> is called every time a new world needs to be drawn</li>
<li>(optional) <code>stop_when</code> is called to determine if the universe
needs to stop</li>
<li>(optional) <code>last_draw</code> is called instead of <code>to_draw</code> to draw
the last world</li>
<li>(optional) <code>setup</code> is called before the universe starts; the
handlers are the internal event handlers for <code>on</code> which <code>setup</code>
is expected to connect to the appropriate elements and events</li>
<li>(optional) <code>teardown</code> is called after the universe has ended,
before on_stop; the handlers are the same as passed to <code>setup</code>
and can be used to cancel the event handling</li>
<li>(optional) <code>on_stop</code> is called after the universe has ended,
after teardown</li>
</ul>
<!-- ... -->

<p>The canvas need not be an actual canvas: it can be any element you
wish to “draw” the world with.  It can be (part of) the body of an
event-driven page.  In this case, you will also have a different
concept of “scene”.</p>
<p>To stop the world from <code>on_tick</code> etc., return <code>stop_with(new_world)</code>
instead of <code>new_world</code>.</p>
<p>For details on key press handling, see <code>handle_keys</code>.  If you want
to use a different key press handling library, set the <code>handle_keys</code>
option to a function with the same api as <code>handle_keys</code>.</p>
<p>For details on mouse click handling, see <code>handle_click</code>.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.<span class="hljs-function"><span class="hljs-title">bigbang</span> = <span class="hljs-params">(opts)</span> -&gt;</span>                                           <span class="hljs-comment"># {{{1</span>
  tickless    = opts.tickless
  anim        = opts.animate || requestAnimationFrame
  world       = opts.world
  fps         = opts.fps || <span class="hljs-number">60</span>
  done        = opts.stop_when?(world) || <span class="hljs-literal">false</span>
  last        = +<span class="hljs-keyword">new</span> Date
  changes     = []
  setup_value = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> tickless &amp;&amp; (opts.on_tick || opts.fps || opts.animate)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'tickless: incompatible option(s)'</span>

  <span class="hljs-function"><span class="hljs-title">draw</span> = <span class="hljs-params">(w,d)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> d &amp;&amp; opts.last_draw
      opts.last_draw(w)(opts.canvas)
    <span class="hljs-keyword">else</span>
      opts.to_draw(w)(opts.canvas)

  <span class="hljs-function"><span class="hljs-title">draw_changes</span> = -&gt;</span>
    <span class="hljs-keyword">for</span> {<span class="hljs-attribute">world</span>:w,<span class="hljs-attribute">done</span>:d} <span class="hljs-keyword">in</span> changes
      draw w, d
    changes = []

  <span class="hljs-function"><span class="hljs-title">change</span> = <span class="hljs-params">(f, args...)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> done || !f
    x = f world, args...
    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">instanceof</span> _Stop
      world = x.world
      done  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span>
      world = x
      done  = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> opts.stop_when? world
    <span class="hljs-keyword">if</span> tickless
      draw world, done
      finish() <span class="hljs-keyword">if</span> done
    <span class="hljs-keyword">else</span>
      changes.push {world,done}

  <span class="hljs-function"><span class="hljs-title">key</span>   = <span class="hljs-params">(k)</span> -&gt;</span> change opts.on_key, k
  <span class="hljs-function"><span class="hljs-title">click</span> = <span class="hljs-params">(x,y)</span> -&gt;</span> change opts.on_click, x, y

  handlers = {}
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> opts.<span class="hljs-literal">on</span> || {}
    <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(k,v)</span> -&gt;</span> handlers[k] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span> change v, args...

  <span class="hljs-function"><span class="hljs-title">tick</span> = <span class="hljs-params">(t)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> t - last &gt; <span class="hljs-number">1000</span> / fps
      last = t; change opts.on_tick, t
    draw_changes()
    <span class="hljs-keyword">unless</span> done
      anim tick
    <span class="hljs-keyword">else</span>
      finish()

  <span class="hljs-function"><span class="hljs-title">finish</span> = -&gt;</span>
    cancel_keys?(); cancel_click?()
    tv = opts.teardown? opts.canvas, handlers, setup_value
    opts.on_stop? world, tv

  hk            = opts.handle_keys  || handle_keys
  hc            = opts.handle_click || handle_click
  cancel_keys   = opts.on_key   &amp;&amp; hk opts.canvas, key  , opts.$
  cancel_click  = opts.on_click &amp;&amp; hc opts.canvas, click, opts.$
  setup_value   = opts.setup? opts.canvas, handlers

  draw world, done
  anim tick <span class="hljs-keyword">unless</span> tickless</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>stop the universe; see bigbang</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.stop_with = <span class="hljs-function"><span class="hljs-title">stop_with</span> = <span class="hljs-params">(w)</span> -&gt;</span> <span class="hljs-keyword">new</span> _Stop w</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>wrapper class for stop_with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Stop</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@world</span>)</span> -&gt;</span>
B._Stop = _Stop</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="scene-functions">scene functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>empty scene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.empty_scene = <span class="hljs-function"><span class="hljs-title">empty_scene</span> = <span class="hljs-params">(width, height)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
  canvas.width = width; canvas.height = height</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>text with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_text = place_text =                                     <span class="hljs-comment"># {{{1</span>
  <span class="hljs-function"><span class="hljs-params">(string, x, y, fontsize, colour, scene, $ = <span class="hljs-built_in">window</span>.$)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
    scene canvas
    ctx = canvas.getContext <span class="hljs-string">'2d'</span>
    ctx.save()
    ctx.font          = <span class="hljs-string">"<span class="hljs-subst">#{fontsize}</span> sans-serif"</span>
    ctx.fillStyle     = colour
    ctx.textBaseline  = <span class="hljs-string">'bottom'</span>
    {w,h}             = measure_text $, string, fontsize, <span class="hljs-string">'sans-serif'</span>
    ctx.fillText string, Math.round(x - w / <span class="hljs-number">2</span>), Math.round(y + h / <span class="hljs-number">2</span>)
    ctx.restore()</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>image with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_image = <span class="hljs-function"><span class="hljs-title">place_image</span> = <span class="hljs-params">(image, x, y, scene)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
  scene canvas
  ctx = canvas.getContext <span class="hljs-string">'2d'</span>
  x_  = x - Math.round(image.width  / <span class="hljs-number">2</span>)
  y_  = y - Math.round(image.height / <span class="hljs-number">2</span>)
  ctx.drawImage image, x_, y_</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>… TODO: more scene and image functions …</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="keyboard-functions">keyboard functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>Handle key presses.  Listens to keydown on elem, calls f with the
key_to_string’d key; returns a function that cancels the listening.
the key presses handled are a-z, 0-9, and the keys in keycodes (with
the exception of SHIFT); with and without shift; when alt, ctrl, or
meta is pressed, the key press is ignored.</p>
<p>Why only this limited set of key presses you ask?  Because of
browser and keyboard layout inconsistencies.  For example, a German
keyboard layout will result in incorrect results with chromium, and
even less correct results with firefox.  The key presses currently
handled seem to be the ones that work correctly in both firefox and
chromium, for both US English and German keyboard layouts.  YMMV.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.handle_keys = <span class="hljs-function"><span class="hljs-title">handle_keys</span> = <span class="hljs-params">(elem, f, $ = <span class="hljs-built_in">window</span>.$)</span> -&gt;</span>        <span class="hljs-comment"># {{{1</span>
  <span class="hljs-function"><span class="hljs-title">h</span> = <span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> !e.altKey &amp;&amp; !e.ctrlKey &amp;&amp; !e.metaKey &amp;&amp;
        e.which != keycodes.SHIFT
      k = key_to_string e.which, e.shiftKey; f k <span class="hljs-keyword">if</span> k
      k == <span class="hljs-literal">null</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">true</span>
  $(elem).<span class="hljs-literal">on</span> <span class="hljs-string">'keydown'</span>, h<span class="hljs-function">
  -&gt;</span> $(elem).<span class="hljs-literal">off</span> <span class="hljs-string">'keydown'</span>, h</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Turn keypress into something usable: a-z without shift is returned
as “a”-“z”; A-Z with shift is returned as “A”-“Z”; 0-9 without shift
is returned as “0”-“9”; 0-9 with shift is returned as
“SHIFT_0”..”SHIFT_9”; the other key codes are retured as the keys in
keycodes, lowercase when without shift (e.g. “left”), uppercase when
with shift (e.g. “HOME”).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.key_to_string = <span class="hljs-function"><span class="hljs-title">key_to_string</span> = <span class="hljs-params">(which, shift)</span> -&gt;</span>             <span class="hljs-comment"># {{{1</span>
  w = which; s = shift
  <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> keyranges.ALPHA.from &lt;= w &lt;= keyranges.ALPHA.to
      c = String.fromCharCode w
      <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> c <span class="hljs-keyword">else</span> c.toLowerCase()
    <span class="hljs-keyword">when</span> keyranges.NUM.from &lt;= w &lt;= keyranges.NUM.to
      c = String.fromCharCode w
      <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> <span class="hljs-string">"SHIFT_<span class="hljs-subst">#{c}</span>"</span> <span class="hljs-keyword">else</span> c
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> keycodes
        <span class="hljs-keyword">if</span> v == w
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> k <span class="hljs-keyword">else</span> k.toLowerCase()
      <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>key codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keycodes = keycodes =
  <span class="hljs-attribute">BACKSPACE</span>: <span class="hljs-number">8</span>, <span class="hljs-attribute">COMMA</span>: <span class="hljs-number">188</span>, <span class="hljs-attribute">DELETE</span>: <span class="hljs-number">46</span>, <span class="hljs-attribute">DOWN</span>: <span class="hljs-number">40</span>, <span class="hljs-attribute">END</span>: <span class="hljs-number">35</span>, <span class="hljs-attribute">ENTER</span>: <span class="hljs-number">13</span>,
  <span class="hljs-attribute">ESCAPE</span>: <span class="hljs-number">27</span>, <span class="hljs-attribute">HOME</span>: <span class="hljs-number">36</span>, <span class="hljs-attribute">LEFT</span>: <span class="hljs-number">37</span>, <span class="hljs-attribute">PAGE_DOWN</span>: <span class="hljs-number">34</span>, <span class="hljs-attribute">PAGE_UP</span>: <span class="hljs-number">33</span>,
  <span class="hljs-attribute">PERIOD</span>: <span class="hljs-number">190</span>, <span class="hljs-attribute">RIGHT</span>: <span class="hljs-number">39</span>, <span class="hljs-attribute">SHIFT</span>: <span class="hljs-number">16</span>, <span class="hljs-attribute">SPACE</span>: <span class="hljs-number">32</span>, <span class="hljs-attribute">TAB</span>: <span class="hljs-number">9</span>, <span class="hljs-attribute">UP</span>: <span class="hljs-number">38</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>key ranges</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keyranges = keyranges =
  <span class="hljs-attribute">ALPHA</span>: { <span class="hljs-attribute">from</span>: <span class="hljs-number">65</span>, <span class="hljs-attribute">to</span>: <span class="hljs-number">90</span> }, <span class="hljs-attribute">NUM</span>: { <span class="hljs-attribute">from</span>: <span class="hljs-number">48</span>, <span class="hljs-attribute">to</span>: <span class="hljs-number">57</span> }, <span class="hljs-comment"># ...</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="mouse-functions">mouse functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Handle mouse clicks.  Listens to click on elem, calls f with the
{x,y}; returns a function that cancels the listening.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.handle_click = <span class="hljs-function"><span class="hljs-title">handle_click</span> = <span class="hljs-params">(elem, f, $ = <span class="hljs-built_in">window</span>.$)</span> -&gt;</span>
  <span class="hljs-function"><span class="hljs-title">h</span> = <span class="hljs-params">(e)</span> -&gt;</span> {x,y} = mouse_position e; f x, y; <span class="hljs-literal">false</span>
  $(elem).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, h<span class="hljs-function">
  -&gt;</span> $(elem).<span class="hljs-literal">off</span> <span class="hljs-string">'click'</span>, h</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>relative mouse position; returns {x,y}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.mouse_position = mouse_position =                             <span class="hljs-comment"># {{{1</span>
  <span class="hljs-function"><span class="hljs-params">(event, elem = event.target, $ = <span class="hljs-built_in">window</span>.$, cache = {})</span> -&gt;</span>
    e            = $(elem)
    cache.left  ?= (e.outerWidth()  - e.width() ) / <span class="hljs-number">2</span>
    cache.top   ?= (e.outerHeight() - e.height()) / <span class="hljs-number">2</span>
    <span class="hljs-attribute">x</span>: event.offsetX - cache.left, <span class="hljs-attribute">y</span>: event.offsetY - cache.top</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="miscellaneous-functions">miscellaneous functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>measure text height and width using a temporary hidden div;
returns {w:width,h:height}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.measure_text = <span class="hljs-function"><span class="hljs-title">measure_text</span> = <span class="hljs-params">($, text, size, family)</span> -&gt;</span>      <span class="hljs-comment"># {{{1</span>
  c = measure_text.cache[<span class="hljs-string">"<span class="hljs-subst">#{size}</span>|<span class="hljs-subst">#{family}</span>|<span class="hljs-subst">#{text}</span>"</span>]
  <span class="hljs-keyword">return</span> c <span class="hljs-keyword">if</span> c
  d = $ <span class="hljs-string">'&lt;div&gt;'</span>; d.text text
  d.css <span class="hljs-attribute">display</span>: <span class="hljs-string">'none'</span>, <span class="hljs-string">'font-size'</span>: size, <span class="hljs-string">'font-family'</span>: family
  $(<span class="hljs-string">'body'</span>).append d
  w = d.width(); h = d.height()
  d.remove()
  measure_text.cache[<span class="hljs-string">"<span class="hljs-subst">#{size}</span>|<span class="hljs-subst">#{family}</span>|<span class="hljs-subst">#{text}</span>"</span>] = {w,h}
measure_text.cache = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <!-- vim: set tw=70 sw=2 sts=2 et fdm=marker : -->

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
