<!DOCTYPE html>

<html>
<head>
  <title>bigbang.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bigbang.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <!--
##
{{{1 -->

<pre><code>File        : bigbang.coffee
Maintainer  : Felix C. Stegerman &lt;flx@obfusk.net&gt;
Date        : 2013-10-16

Copyright   : Copyright (C) 2013  Felix C. Stegerman
Licence     : GPLv2 or GPLv3 or LGPLv3 or EPLv1</code></pre>
<!-- }}}1
##
-->

<p>graphical functional programming for js/coffee</p>
<p>Create graphical programs (like games) in coffeescript or javascript
using plain mathematical functions; inspired by the 2htdp library
for racket.</p>
<p><a href="https://github.com/obfusk/bigbang.coffee">https://github.com/obfusk/bigbang.coffee</a></p>
<p>License: GPLv2 or GPLv3 or LGPLv3 or EPLv1.</p>
<h2>underscore + exports</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>U = <span class="keyword">this</span>._ || require <span class="string">'underscore'</span>
<span class="function"><span class="title">B</span></span> = -&gt; B.bigbang arguments...
<span class="keyword">if</span> exports? <span class="keyword">then</span> module.exports = B <span class="keyword">else</span> <span class="keyword">this</span>.bigbang = B</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>requestAnimationFrame &amp; polyfill</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>requestAnimationFrame polyfill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">polyRequestAnimationFrame</span></span> = (delay = <span class="number">17</span>) -&gt;                     <span class="comment"># {{{1</span>
    console.warn <span class="string">'polyfilling *RequestAnimationFrame ...'</span>
    last = <span class="number">0</span>
    (cb) -&gt;
      cur   = +<span class="keyword">new</span> Date
      dt    = Math.max <span class="number">0</span>, delay - (cur - last)
      last  = cur + dt
      window.setTimeout (-&gt; cb +<span class="keyword">new</span> Date), dt</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
               <!-- }}}1 -->

<p>NB: we use the prefixed versions of requestAnimationFrame b/c
requestAnimationFrame itself uses relative timestamps; also good to
know: webkitRequestAnimationFrame uses floating point timestamps.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.requestAnimationFrame = anim =
  window?.webkitRequestAnimationFrame ||
  window?.mozRequestAnimationFrame ||
  polyRequestAnimationFrame()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>bigbang, stop_with, and keys</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>big bang: start a new universe whose behaviour is specified by the
options and handler functions designated</p>
<pre><code>bigbang
  canvas:       html5_canvas,
  fps:          int,
  world:        object,
  on_tick:      ((world) -&gt; new_world),
  on_key:       ((world, key) -&gt; new_world),
  to_draw:      ((world) -&gt; scene),
  stop_when:    ((world) -&gt; boolean),
  last_picture: ((world) -&gt; scene)</code></pre>
<p>Options:</p>
<ul>
<li><code>canvas</code> is the HTML5 canvas to draw on</li>
<li><code>fps</code> is the requested frame rate (defaults to 60)</li>
<li><code>world</code> is the object representing the initial world</li>
<li><code>on_tick</code> is called every clock tick to update the world
(optional)</li>
<li><code>on_key</code> is called every time a key is pressed to update the
world (optional)</li>
<li><code>to_draw</code> is called every time a new world needs to be drawn</li>
<li><code>stop_when</code> is called to determine if the universe needs to stop
(optional)</li>
<li><code>last_picture</code> is called instead of <code>to_draw</code> to draw the last
world (optional)</li>
</ul>
<!-- ... -->

<p>To stop the world from <code>on_tick</code> or <code>on_key</code>, return
<code>stop_with(new_world)</code> instead of <code>new_world</code>.</p>
<p>For details on key press handling, see <code>handle_keys</code>.  If you want
to use a different key press handling library, set the <code>handle_keys</code>
option to a function with the same api as <code>handle_keys</code>.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.<span class="function"><span class="title">bigbang</span></span> = (opts) -&gt;                                           <span class="comment"># {{{1</span>
  world   = opts.world; fps = opts.fps || <span class="number">60</span>
  done    = opts.stop_when?(world) || <span class="literal">false</span>
  last    = +<span class="keyword">new</span> Date
  changed = <span class="literal">false</span>

  draw = () -&gt;
    f = <span class="keyword">if</span> done &amp;&amp; opts.last_picture
      opts.last_picture
    <span class="keyword">else</span>
      opts.to_draw
    f(world)(opts.canvas)

  <span class="function"><span class="title">change</span></span> = (x) -&gt;
    <span class="keyword">if</span> x <span class="keyword">instanceof</span> _Stop
      world = x.world
      done  = <span class="literal">true</span>
    <span class="keyword">else</span>
      world = x
      done  = <span class="literal">true</span> <span class="keyword">if</span> opts.stop_when? world
    cancel_keys?() <span class="keyword">if</span> done
    changed = <span class="literal">true</span>

  <span class="function"><span class="title">key</span></span> = (k) -&gt; change opts.on_key(world, k) <span class="keyword">if</span> opts.on_key

  <span class="function"><span class="title">tick</span></span> = (t) -&gt;
    <span class="keyword">if</span> t - last &gt; <span class="number">1000</span> / opts.fps
      last = t
      change opts.on_tick(world) <span class="keyword">if</span> opts.on_tick
    <span class="keyword">if</span> changed
      draw(); changed = <span class="literal">false</span>
    anim tick <span class="keyword">unless</span> done

  cancel_keys = (opts.handle_keys || handle_keys) opts.canvas, key,
                  opts.$
  anim tick</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
               <!-- }}}1 -->

<p>stop the universe; see bigbang</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.stop_with = <span class="function"><span class="title">stop_with</span></span> = (w) -&gt; <span class="keyword">new</span> _Stop w</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>wrapper class for stop_with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">_Stop</span></span>
  constructor: (<span class="property">@world</span>) -&gt;
B._Stop = _Stop</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>Handle key presses.  Listens to keydown on elem, calls f with the
key_to_string&#39;d key; returns a function that cancels the listening.
the key presses handled are a-z, 0-9, and the keys in keycodes (with
the exception of SHIFT); with and without shift; when alt, ctrl, or
meta is pressed, the key press is ignored.</p>
<p>Why only this limited set of key presses you ask?  Because of
browser and keyboard layout inconsistencies.  For example, a German
keyboard layout will result in incorrect results with chromium, and
even less correct results with firefox.  The key presses currently
handled seem to be the ones that work correctly in both firefox and
chromium, for both US English and German keyboard layouts.  YMMV.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.handle_keys = <span class="function"><span class="title">handle_keys</span></span> = (elem, f, $ = window.$) -&gt;        <span class="comment"># {{{1</span>
  <span class="function"><span class="title">h</span></span> = (e) -&gt;
    <span class="keyword">if</span> !e.altKey &amp;&amp; !e.ctrlKey &amp;&amp; !e.metaKey &amp;&amp;
        e.which != keycodes.SHIFT
      k = key_to_string e.which, e.shiftKey; f k <span class="keyword">if</span> k
      k == <span class="literal">null</span>
    <span class="keyword">else</span>
      <span class="literal">true</span>
  $(elem).<span class="literal">on</span> <span class="string">'keydown'</span>, h
  -&gt; $(elem).<span class="literal">off</span> <span class="string">'keydown'</span>, h</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
               <!-- }}}1 -->

<p>Turn keypress into something usable: a-z without shift is returned
as &quot;a&quot;-&quot;z&quot;; A-Z with shift is returned as &quot;A&quot;-&quot;Z&quot;; 0-9 without shift
is returned as &quot;0&quot;-&quot;9&quot;; 0-9 with shift is returned as
&quot;SHIFT_0&quot;..&quot;SHIFT_9&quot;; the other key codes are retured as the keys in
keycodes, lowercase when without shift (e.g. &quot;left&quot;), uppercase when
with shift (e.g. &quot;HOME&quot;).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.key_to_string = <span class="function"><span class="title">key_to_string</span></span> = (which, shift) -&gt;             <span class="comment"># {{{1</span>
  w = which; s = shift
  <span class="keyword">switch</span>
    <span class="keyword">when</span> keyranges.ALPHA.from &lt;= w &lt;= keyranges.ALPHA.to
      c = String.fromCharCode w
      <span class="keyword">if</span> s <span class="keyword">then</span> c <span class="keyword">else</span> c.toLowerCase()
    <span class="keyword">when</span> keyranges.NUM.from &lt;= w &lt;= keyranges.NUM.to
      c = String.fromCharCode w
      <span class="keyword">if</span> s <span class="keyword">then</span> <span class="string">"SHIFT_<span class="subst">#{c}</span>"</span> <span class="keyword">else</span> c
    <span class="keyword">else</span>
      <span class="keyword">for</span> k, v <span class="keyword">of</span> keycodes
        <span class="keyword">if</span> v == w
          <span class="keyword">return</span> <span class="keyword">if</span> s <span class="keyword">then</span> k <span class="keyword">else</span> k.toLowerCase()
      <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
               <!-- }}}1 -->

<p>key codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keycodes = keycodes =
  BACKSPACE: <span class="number">8</span>, COMMA: <span class="number">188</span>, DELETE: <span class="number">46</span>, DOWN: <span class="number">40</span>, END: <span class="number">35</span>, ENTER: <span class="number">13</span>,
  ESCAPE: <span class="number">27</span>, HOME: <span class="number">36</span>, LEFT: <span class="number">37</span>, PAGE_DOWN: <span class="number">34</span>, PAGE_UP: <span class="number">33</span>,
  PERIOD: <span class="number">190</span>, RIGHT: <span class="number">39</span>, SHIFT: <span class="number">16</span>, SPACE: <span class="number">32</span>, TAB: <span class="number">9</span>, UP: <span class="number">38</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>key ranges</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keyranges = keyranges =
  ALPHA: { from: <span class="number">65</span>, to: <span class="number">90</span> }, NUM: { from: <span class="number">48</span>, to: <span class="number">57</span> }, <span class="comment"># ...</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2>scene functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>empty scene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.empty_scene = <span class="function"><span class="title">empty_scene</span></span> = (width, height) -&gt; (canvas) -&gt;
  canvas.width = width; canvas.height = height</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>text with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_text = place_text =                                     <span class="comment"># {{{1</span>
  (string, x, y, fontsize, colour, scene, $ = window.$) -&gt; (canvas) -&gt;
    scene canvas
    ctx = canvas.getContext <span class="string">'2d'</span>
    ctx.save()
    ctx.font          = <span class="string">"<span class="subst">#{fontsize}</span> sans-serif"</span>
    ctx.fillStyle     = colour
    ctx.textBaseline  = <span class="string">'bottom'</span>
    [w,h]             = measure_text $, string, fontsize, <span class="string">'sans-serif'</span>
    ctx.fillText string, Math.round(x - w / <span class="number">2</span>), Math.round(y + h / <span class="number">2</span>)
    ctx.restore()</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
               <!-- }}}1 -->

<p>image with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_image = <span class="function"><span class="title">place_image</span></span> = (image, x, y, scene) -&gt; (canvas) -&gt;
  scene canvas
  ctx = canvas.getContext <span class="string">'2d'</span>
  x_  = x - Math.round(image.width  / <span class="number">2</span>)
  y_  = y - Math.round(image.height / <span class="number">2</span>)
  ctx.drawImage image, x_, y_</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>... TODO: more scene and image functions ...</p>
<h2>miscellaneous functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>measure text height and width using a temporary hidden div;
returns [width, height]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.measure_text = <span class="function"><span class="title">measure_text</span></span> = ($, text, size, family) -&gt;      <span class="comment"># {{{1</span>
  c = measure_text.cache[<span class="string">"<span class="subst">#{size}</span>|<span class="subst">#{family}</span>|<span class="subst">#{text}</span>"</span>]
  <span class="keyword">return</span> c <span class="keyword">if</span> c
  d = $ <span class="string">'&lt;div&gt;'</span>; d.text text
  d.css display: <span class="string">'none'</span>, <span class="string">'font-size'</span>: size, <span class="string">'font-family'</span>: family
  $(<span class="string">'body'</span>).append d
  w = d.width(); h = d.height()
  d.remove()
  measure_text.cache[<span class="string">"<span class="subst">#{size}</span>|<span class="subst">#{family}</span>|<span class="subst">#{text}</span>"</span>] = [w,h]
measure_text.cache = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
               <!-- }}}1 -->

<!-- vim: set tw=70 sw=2 sts=2 et fdm=marker : -->


            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
