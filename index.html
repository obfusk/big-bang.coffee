<!DOCTYPE html>

<html>
<head>
  <title>bigbang.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bigbang.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <!--
##
{{{1 -->

<pre><code>File        : bigbang.coffee
Maintainer  : Felix C. Stegerman &lt;flx@obfusk.net&gt;
<span class="hljs-built_in">Date</span>        : <span class="hljs-number">2020</span><span class="hljs-number">-09</span><span class="hljs-number">-02</span>

Copyright   : Copyright (C) <span class="hljs-number">2020</span>  Felix C. Stegerman
Licence     : LGPLv3+
Version     : v0<span class="hljs-number">.2</span><span class="hljs-number">.1</span></code></pre>
<!-- }}}1
##
-->

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>graphical/evented functional programming for js/coffee</p>
<p>Create graphical and evented programs (like games) in coffeescript
or javascript using plain mathematical functions; inspired by the
2htdp library for racket.</p>
<p><a href="https://github.com/obfusk/bigbang.coffee">https://github.com/obfusk/bigbang.coffee</a></p>
<p>License: LGPLv3+.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="underscore--exports">underscore + exports</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
U = <span class="hljs-built_in">this</span>._ || <span class="hljs-built_in">require</span> <span class="hljs-string">&#x27;underscore&#x27;</span>
<span class="hljs-function"><span class="hljs-title">B</span> = -&gt;</span> B.bigbang <span class="hljs-built_in">arguments</span>...
<span class="hljs-keyword">if</span> <span class="hljs-built_in">exports</span>? <span class="hljs-keyword">then</span> <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = B <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.bigbang = B</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="requestanimationframe--polyfill">requestAnimationFrame &amp; polyfill</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>requestAnimationFrame polyfill; the default delay is 17 milliseconds
(ca. 60 fps)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.polyRequestAnimationFrame = polyRequestAnimationFrame =       <span class="hljs-comment"># {{{1</span>
  (opts = {}) -&gt;
    <span class="hljs-built_in">console</span>.warn <span class="hljs-string">&#x27;polyfilling *RequestAnimationFrame ...&#x27;</span> <span class="hljs-keyword">if</span> opts.warn
    delay = opts.delay || <span class="hljs-number">17</span>; next = <span class="hljs-number">0</span>
    (cb) -&gt;
      cur   = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>
      dt    = <span class="hljs-built_in">Math</span>.max <span class="hljs-number">0</span>, delay - (cur - next)
      next  = cur + dt
      <span class="hljs-built_in">window</span>.<span class="hljs-built_in">setTimeout</span> (<span class="hljs-function">-&gt;</span> cb +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>), dt</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>NB: we use the prefixed versions of requestAnimationFrame b/c
requestAnimationFrame itself uses relative timestamps; also good to
know: webkitRequestAnimationFrame uses floating point timestamps.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.requestAnimationFrame = requestAnimationFrame =
  <span class="hljs-built_in">window</span>?.requestAnimationFrame ||
  <span class="hljs-built_in">window</span>?.webkitRequestAnimationFrame ||
  <span class="hljs-built_in">window</span>?.mozRequestAnimationFrame ||
  polyRequestAnimationFrame warn: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="bigbang--stop_with">bigbang &amp; stop_with</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>big bang: start a new universe whose behaviour is specified by the
options and handler functions designated</p>
<pre><code>bigbang
  world:        object,
  canvas:       element|object,
  to_draw:      <span class="hljs-function">(<span class="hljs-params">(world)</span> -&gt;</span> scene),
  on_tick:      <span class="hljs-function">(<span class="hljs-params">(world, time)</span> -&gt;</span> new_world),
  fps:          int,
  queue:        boolean|int,
  animate:      requestAnimationFrame-like-function,
  on_key:       <span class="hljs-function">(<span class="hljs-params">(world, key)</span> -&gt;</span> new_world),
  on_click:     <span class="hljs-function">(<span class="hljs-params">(world, x, y)</span> -&gt;</span> new_world),
  on:           { foo: <span class="hljs-function">(<span class="hljs-params">(world, ...)</span> -&gt;</span> new_world), ... },
  stop_when:    <span class="hljs-function">(<span class="hljs-params">(world)</span> -&gt;</span> boolean),
  last_draw:    <span class="hljs-function">(<span class="hljs-params">(world)</span> -&gt;</span> scene),
  setup:        <span class="hljs-function">(<span class="hljs-params">(canvas, handlers)</span> -&gt;</span> setup_value),
  teardown:     <span class="hljs-function">(<span class="hljs-params">(canvas, handlers, setup_value)</span> -&gt;</span>
                  teardown_value),
  on_stop:      <span class="hljs-function">(<span class="hljs-params">(world, teardown_value)</span> -&gt;</span> ...)
-&gt; {get_world,get_done}</code></pre>
<p>Options:</p>
<ul>
<li><p><code>world</code> is the object representing the initial world</p>
</li>
<li><p><code>canvas</code> is the HTML5 canvas (or equivalent) to draw on</p>
</li>
<li><p><code>to_draw</code> is called every time a new world needs to be drawn</p>
</li>
<li><p>(optional) <code>on_tick</code></p>
<ul>
<li>when passed, the universe is in “clock mode”: all changes are
queued (unless <code>queue</code> is <code>false</code>) and drawing happens every
actual clock tick (usually approx. 60 fps); <code>on_tick</code> is called
every “virtual” clock tick (as determined by <code>fps</code>)</li>
<li>otherwise, events are processed immediately (by updating the
world and re-drawing the scene)</li>
</ul>
</li>
<li><p>(optional) <code>fps</code> is the requested frame rate; defaults to 60</p>
</li>
<li><p>(optional) <code>queue</code> when set to <code>false</code>, disables queueing in
“clock mode”; when set to an <code>int</code>, restricts the queue size to
that number of items (e.g. to draw every actual tick and ignore
all but the last world, set this to <code>1</code>)</p>
</li>
<li><p>(optional) <code>animate</code> the requestAnimationFrame-like function to
use as the clock in “clock mode”</p>
</li>
<li><p>(optional) <code>on_key</code> is called every time a key is pressed to
update the world</p>
</li>
<li><p>(optional) <code>on_click</code> is called every time the mouse is clicked
inside the canvas to update the world</p>
</li>
<li><p>(optional) <code>on</code> contains handlers for user-defined events;
<code>setup</code> and <code>teardown</code> are used to connect handlers to elements
and events; when the user-defined event is triggered, the
appropriate function is called</p>
</li>
<li><p>(optional) <code>stop_when</code> is called to determine if the universe
needs to stop</p>
</li>
<li><p>(optional) <code>last_draw</code> is called instead of <code>to_draw</code> to draw
the last world</p>
</li>
<li><p>(optional) <code>setup</code> is called before the universe starts; the
handlers are the internal event handlers for <code>on</code> which <code>setup</code>
is expected to connect to the appropriate elements and events</p>
</li>
<li><p>(optional) <code>teardown</code> is called after the universe has ended,
before on_stop; the handlers are the same as passed to <code>setup</code>
and can be used to cancel the event handling</p>
</li>
<li><p>(optional) <code>on_stop</code> is called after the universe has ended,
after teardown</p>
</li>
</ul>
<p>Returns:</p>
<ul>
<li><code>get_world</code> is a function that returns the current world</li>
<li><code>get_done</code> is a function that returns whether the universe is
stopped</li>
</ul>
<!-- ... -->

<p>The canvas need not be an actual canvas: it can be any element you
wish to “draw” the world with.  It can be (part of) the body of an
event-driven page.  In this case, you will also have a different
concept of “scene”.  For more on “scenes”, see <code>mk_scene</code>.</p>
<p>To stop the world from <code>on_tick</code> etc., return <code>stop_with(new_world)</code>
instead of <code>new_world</code>.</p>
<p>For details on key press handling, see <code>handle_keys</code>.  If you want
to use a different key press handling library, set the <code>handle_keys</code>
option to a function with the same api as <code>handle_keys</code>.</p>
<p>For details on mouse click handling, see <code>handle_click</code>.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.bigbang = <span class="hljs-function"><span class="hljs-params">(opts)</span> -&gt;</span>                                           <span class="hljs-comment"># {{{1</span>
  tickless      = !opts.on_tick
  queue         = opts.queue ? <span class="hljs-literal">true</span>
  anim          = opts.animate || requestAnimationFrame
  world         = opts.world
  delay         = <span class="hljs-number">1000</span> / (opts.fps || <span class="hljs-number">60</span>)
  delay_margin  = delay / <span class="hljs-number">17</span>                                    <span class="hljs-comment">#  ???</span>
  done          = opts.stop_when?(world) || <span class="hljs-literal">false</span>
  next          = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span> + delay
  changes       = []
  setup_value   = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> tickless &amp;&amp; (opts.queue? || opts.fps || opts.animate)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span> <span class="hljs-string">&#x27;queue, fps and animate require on_tick&#x27;</span>
<span class="hljs-function">
  <span class="hljs-title">draw</span> = <span class="hljs-params">(w,d)</span> -&gt;</span>
    f = <span class="hljs-keyword">if</span> d &amp;&amp; opts.last_draw <span class="hljs-keyword">then</span> opts.last_draw <span class="hljs-keyword">else</span> opts.to_draw
    draw_scene(f w) opts.canvas
<span class="hljs-function">
  <span class="hljs-title">draw_changes</span> = -&gt;</span>
    <span class="hljs-keyword">for</span> {world:w,done:d} <span class="hljs-keyword">in</span> changes
      draw w, d
    changes = []
<span class="hljs-function">
  <span class="hljs-title">change</span> = <span class="hljs-params">(f, args...)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> done || !U.isFunction f
    x = f world, args...
    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">instanceof</span> _Stop
      world = x.world
      done  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span>
      world = x
      done  = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> opts.stop_when? world
    <span class="hljs-keyword">if</span> !tickless &amp;&amp; queue
      changes.shift() <span class="hljs-keyword">if</span> changes.length == queue  <span class="hljs-comment"># != true is OK</span>
      changes.push {world,done}
    <span class="hljs-keyword">else</span>
      draw world, done
      finish() <span class="hljs-keyword">if</span> done

  s = +<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>
<span class="hljs-function">
  <span class="hljs-title">tick</span> = <span class="hljs-params">(t)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> t &gt;= next - delay_margin
      next += delay; change opts.on_tick, t
    draw_changes() <span class="hljs-keyword">if</span> queue
    <span class="hljs-keyword">if</span> done
      finish() <span class="hljs-keyword">if</span> queue
    <span class="hljs-keyword">else</span>
      anim tick
<span class="hljs-function">
  <span class="hljs-title">key</span>   = <span class="hljs-params">(k)</span> -&gt;</span> change opts.on_key, k
<span class="hljs-function">  <span class="hljs-title">click</span> = <span class="hljs-params">(x,y)</span> -&gt;</span> change opts.on_click, x, y

  handlers = {}
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> opts.<span class="hljs-literal">on</span> || {}
    <span class="hljs-keyword">do</span> (k,v) -&gt; handlers[k] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span> change v, args...
<span class="hljs-function">
  <span class="hljs-title">finish</span> = -&gt;</span>
    cancel_keys?(); cancel_click?()
    tv = opts.teardown? opts.canvas, handlers, setup_value
    opts.on_stop? world, tv

  hk            = opts.handle_keys  || handle_keys
  hc            = opts.handle_click || handle_click
  cancel_keys   = opts.on_key   &amp;&amp; hk opts.canvas, key  , opts.$
  cancel_click  = opts.on_click &amp;&amp; hc opts.canvas, click, opts.$
  setup_value   = opts.setup? opts.canvas, handlers

  draw world, done
  anim tick <span class="hljs-keyword">unless</span> tickless

  world: (<span class="hljs-function">-&gt;</span> world), done: (<span class="hljs-function">-&gt;</span> done)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>stop the universe; see bigbang</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.stop_with = stop_with = <span class="hljs-function"><span class="hljs-params">(w)</span> -&gt;</span> <span class="hljs-keyword">new</span> _Stop w</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>wrapper class for stop_with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Stop</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(@world)</span> -&gt;</span>
B._Stop = _Stop</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="abstract-scene-functions">abstract scene functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>make a scene</p>
<p>A “scene” is a function that takes a “canvas” and “draws” on it.</p>
<p>A “non-recursive scene” is a “scene” that also takes a second
argument specifying whether any “lower scene” should also be drawn
by it and has a property <code>lower_scene</code> that holds the “lower scene”.
This allows <code>draw_scene</code> to draw multiple scenes using iteration
instead of recursion.</p>
<p><code>mk_scene</code> takes a “non-recursive (lower) scene” and a “regular
scene” and turns the “regular scene” into a “non-recursive scene”
that draws the “lower scene” when needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.mk_scene = mk_scene = <span class="hljs-function"><span class="hljs-params">(scene, f)</span> -&gt;</span>
<span class="hljs-function">  <span class="hljs-title">g</span> = <span class="hljs-params">(canvas, draw_lower = <span class="hljs-literal">true</span>)</span> -&gt;</span> scene? canvas <span class="hljs-keyword">if</span> draw_lower; f canvas
  g.lower_scene = scene; g</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>draw a scene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.draw_scene = draw_scene = <span class="hljs-function"><span class="hljs-params">(scene)</span> -&gt;</span> (canvas) -&gt;
  <span class="hljs-keyword">if</span> (s = scene).lower_scene
    scenes = [scene]; scenes.push s <span class="hljs-keyword">while</span> s = s.lower_scene
    scenes.reverse(); s canvas, <span class="hljs-literal">false</span> <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> scenes; <span class="hljs-literal">null</span>
  <span class="hljs-keyword">else</span>
    scene canvas</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="html5-canvas-scene-functions">HTML5 canvas scene functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>empty scene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.empty_scene = empty_scene = <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span> mk_scene <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
  canvas.width = width; canvas.height = height</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>text with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_text = place_text =                                     <span class="hljs-comment"># {{{1</span>
  (string, x, y, fontsize, colour, scene, $ = <span class="hljs-built_in">window</span>.$) -&gt; \
  mk_scene scene, <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
    ctx = canvas.getContext <span class="hljs-string">&#x27;2d&#x27;</span>
    ctx.save()
    ctx.font          = <span class="hljs-string">&quot;<span class="hljs-subst">#{fontsize}</span> sans-serif&quot;</span>
    ctx.fillStyle     = colour
    ctx.textBaseline  = <span class="hljs-string">&#x27;bottom&#x27;</span>
    {w,h}             = measure_text $, string, fontsize, <span class="hljs-string">&#x27;sans-serif&#x27;</span>
    ctx.fillText string, <span class="hljs-built_in">Math</span>.round(x - w / <span class="hljs-number">2</span>), <span class="hljs-built_in">Math</span>.round(y + h / <span class="hljs-number">2</span>)
    ctx.restore()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>image with center at coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.place_image = place_image = <span class="hljs-function"><span class="hljs-params">(image, x, y, scene)</span> -&gt;</span>
  mk_scene scene, <span class="hljs-function"><span class="hljs-params">(canvas)</span> -&gt;</span>
    ctx = canvas.getContext <span class="hljs-string">&#x27;2d&#x27;</span>
    x_  = x - <span class="hljs-built_in">Math</span>.round(image.width  / <span class="hljs-number">2</span>)
    y_  = y - <span class="hljs-built_in">Math</span>.round(image.height / <span class="hljs-number">2</span>)
    ctx.drawImage image, x_, y_</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>… TODO: more scene and image functions …</p>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="keyboard-functions">keyboard functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <!-- {{{1 -->

<p>Handle key presses.  Listens to keydown on elem, calls f with the
key_to_string’d key; returns a function that cancels the listening.
the key presses handled are a-z, 0-9, and the keys in keycodes (with
the exception of SHIFT); with and without shift; when alt, ctrl, or
meta is pressed, the key press is ignored.</p>
<p>Why only this limited set of key presses you ask?  Because of
browser and keyboard layout inconsistencies.  For example, a German
keyboard layout will result in incorrect results with chromium, and
even less correct results with firefox.  The key presses currently
handled seem to be the ones that work correctly in both firefox and
chromium, for both US English and German keyboard layouts.  YMMV.</p>
<!-- }}}1 -->

            </div>
            
            <div class="content"><div class='highlight'><pre>B.handle_keys = handle_keys = <span class="hljs-function"><span class="hljs-params">(elem, f, $ = <span class="hljs-built_in">window</span>.$)</span> -&gt;</span>        <span class="hljs-comment"># {{{1</span>
<span class="hljs-function">  <span class="hljs-title">h</span> = <span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> !e.altKey &amp;&amp; !e.ctrlKey &amp;&amp; !e.metaKey &amp;&amp;
        e.which != keycodes.SHIFT
      k = key_to_string e.which, e.shiftKey; f k <span class="hljs-keyword">if</span> k
      k == <span class="hljs-literal">null</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">true</span>
  $(elem).<span class="hljs-literal">on</span> <span class="hljs-string">&#x27;keydown&#x27;</span>, h
  -&gt; $(elem).<span class="hljs-literal">off</span> <span class="hljs-string">&#x27;keydown&#x27;</span>, h</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Turn keypress into something usable: a-z without shift is returned
as “a”-“z”; A-Z with shift is returned as “A”-“Z”; 0-9 without shift
is returned as “0”-“9”; 0-9 with shift is returned as
“SHIFT_0”..”SHIFT_9”; the other key codes are retured as the keys in
keycodes, lowercase when without shift (e.g. “left”), uppercase when
with shift (e.g. “HOME”).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.key_to_string = key_to_string = <span class="hljs-function"><span class="hljs-params">(which, shift)</span> -&gt;</span>             <span class="hljs-comment"># {{{1</span>
  w = which; s = shift
  <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> keyranges.ALPHA.<span class="hljs-keyword">from</span> &lt;= w &lt;= keyranges.ALPHA.to
      c = <span class="hljs-built_in">String</span>.fromCharCode w
      <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> c <span class="hljs-keyword">else</span> c.toLowerCase()
    <span class="hljs-keyword">when</span> keyranges.NUM.<span class="hljs-keyword">from</span> &lt;= w &lt;= keyranges.NUM.to
      c = <span class="hljs-built_in">String</span>.fromCharCode w
      <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> <span class="hljs-string">&quot;SHIFT_<span class="hljs-subst">#{c}</span>&quot;</span> <span class="hljs-keyword">else</span> c
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> keycodes
        <span class="hljs-keyword">if</span> v == w
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> s <span class="hljs-keyword">then</span> k <span class="hljs-keyword">else</span> k.toLowerCase()
      <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>key codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keycodes = keycodes =
  BACKSPACE: <span class="hljs-number">8</span>, COMMA: <span class="hljs-number">188</span>, DELETE: <span class="hljs-number">46</span>, DOWN: <span class="hljs-number">40</span>, END: <span class="hljs-number">35</span>, ENTER: <span class="hljs-number">13</span>,
  ESCAPE: <span class="hljs-number">27</span>, HOME: <span class="hljs-number">36</span>, LEFT: <span class="hljs-number">37</span>, PAGE_DOWN: <span class="hljs-number">34</span>, PAGE_UP: <span class="hljs-number">33</span>,
  PERIOD: <span class="hljs-number">190</span>, RIGHT: <span class="hljs-number">39</span>, SHIFT: <span class="hljs-number">16</span>, SPACE: <span class="hljs-number">32</span>, TAB: <span class="hljs-number">9</span>, UP: <span class="hljs-number">38</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>key ranges</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.keyranges = keyranges =
  ALPHA: { from: <span class="hljs-number">65</span>, to: <span class="hljs-number">90</span> }, NUM: { from: <span class="hljs-number">48</span>, to: <span class="hljs-number">57</span> }, <span class="hljs-comment"># ...</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="mouse-functions">mouse functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Handle mouse clicks.  Listens to click on elem, calls f with the
{x,y}; returns a function that cancels the listening.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.handle_click = handle_click = <span class="hljs-function"><span class="hljs-params">(elem, f, $ = <span class="hljs-built_in">window</span>.$)</span> -&gt;</span>
<span class="hljs-function">  <span class="hljs-title">h</span> = <span class="hljs-params">(e)</span> -&gt;</span> {x,y} = mouse_position e; f x, y; <span class="hljs-literal">false</span>
  $(elem).<span class="hljs-literal">on</span> <span class="hljs-string">&#x27;click&#x27;</span>, h
  -&gt; $(elem).<span class="hljs-literal">off</span> <span class="hljs-string">&#x27;click&#x27;</span>, h</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>relative mouse position; returns {x,y}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.mouse_position = mouse_position =
  <span class="hljs-function"><span class="hljs-params">(event, elem = event.target, $ = <span class="hljs-built_in">window</span>.$, cache = {})</span> -&gt;</span>
    e            = $(elem)
    cache.left  ?= (e.outerWidth()  - e.width() ) / <span class="hljs-number">2</span>
    cache.top   ?= (e.outerHeight() - e.height()) / <span class="hljs-number">2</span>
    x: event.offsetX - cache.left, y: event.offsetY - cache.top</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h2 id="miscellaneous-functions">miscellaneous functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>measure text height and width using a temporary hidden div;
returns {w:width,h:height}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>B.measure_text = measure_text = <span class="hljs-function"><span class="hljs-params">($, text, size, family)</span> -&gt;</span>      <span class="hljs-comment"># {{{1</span>
  c = measure_text.cache[<span class="hljs-string">&quot;<span class="hljs-subst">#{size}</span>|<span class="hljs-subst">#{family}</span>|<span class="hljs-subst">#{text}</span>&quot;</span>]
  <span class="hljs-keyword">return</span> c <span class="hljs-keyword">if</span> c
  d = $ <span class="hljs-string">&#x27;&lt;div&gt;&#x27;</span>; d.text text
  d.css display: <span class="hljs-string">&#x27;none&#x27;</span>, <span class="hljs-string">&#x27;font-size&#x27;</span>: size, <span class="hljs-string">&#x27;font-family&#x27;</span>: family
  $(<span class="hljs-string">&#x27;body&#x27;</span>).append d
  w = d.width(); h = d.height()
  d.remove()
  measure_text.cache[<span class="hljs-string">&quot;<span class="hljs-subst">#{size}</span>|<span class="hljs-subst">#{family}</span>|<span class="hljs-subst">#{text}</span>&quot;</span>] = {w,h}
measure_text.cache = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
               <!-- }}}1 -->

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <!-- vim: set tw=70 sw=2 sts=2 et fdm=marker : -->

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
